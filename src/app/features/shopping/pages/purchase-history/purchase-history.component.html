<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="container">
    <button class="btn-back" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Volver
    </button>
    
    <div class="header">
        <h2>Historial de compra</h2>
        <div class="header-actions">
            <app-input-search
                placeholder="Buscar órdenes..."
                (searchChange)="handleSearch($event)">
            </app-input-search>
        </div>
    </div>

    <div class="table-responsive">
        <table class="purchase-table">
            <thead>
                <tr>
                    <th>Orden</th>
                    <th>Usuario</th>
                    <th>Proveedor</th>
                    <th>Fecha Compra</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let orden of ordenesFiltradas">
                    <td>{{orden.id}}</td>
                    <td>{{orden.usuario}}</td>
                    <td>{{orden.proveedor}}</td>
                    <td>{{orden.fechaCompra | date:'dd/MM/yyyy HH:mm:ss'}}</td>
                    <td>{{orden.total | currency:'Q '}}</td>
                    <td>
                        <span class="status-badge" [class.entregado]="orden.estado === 'Entregado'">
                            {{orden.estado}}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" (click)="verDetalles(orden)">
                            Ver detalle
                        </button>
                    </td>
                </tr>
                <tr *ngIf="ordenesFiltradas.length === 0">
                    <td colspan="7" class="no-results">No se encontraron órdenes</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-controls" *ngIf="ordenesFiltradas.length > itemsPorPagina">
        <button (click)="paginaAnterior()" [disabled]="paginaActual === 1" class="btn-pagination">
            Anterior
        </button>
        <span>Página {{paginaActual}} de {{totalPaginas}}</span>
        <button (click)="paginaSiguiente()" [disabled]="paginaActual === totalPaginas" class="btn-pagination">
            Siguiente
        </button>
    </div>
</div>

<!-- Modal para detalles de orden -->
<div *ngIf="mostrarModalDetalles" class="modal-overlay">
    <div class="modal-content">
        <h2>Detalle de compra</h2>
        
        <div class="order-info">
            <div><strong>Orden:</strong> {{ordenSeleccionada?.id}}</div>
            <div><strong>Usuario:</strong> {{ordenSeleccionada?.usuario}}</div>
            <div><strong>Proveedor:</strong> {{ordenSeleccionada?.proveedor}}</div>
            <div><strong>Fecha de compra:</strong> {{ordenSeleccionada?.fechaCompra | date:'dd/MM/yyyy'}}</div>
            <div><strong>Estado:</strong> {{ordenSeleccionada?.estado}}</div>
        </div>

        <table class="details-table">
            <thead>
                <tr>
                    <th>Productos</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Total</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let item of detallesOrden">
                    <td>{{item.producto}}</td>
                    <td>{{item.cantidad}}</td>
                    <td>{{item.precioUnitario | currency:'Q '}}</td>
                    <td>{{item.total | currency:'Q '}}</td>
                    <td>
                        <span class="status-badge" [class.entregado]="item.estado === 'Entregado'">
                            {{item.estado}}
                        </span>
                    </td>
                </tr>
                <tr class="total-row">
                    <td colspan="3"><strong>Total general</strong></td>
                    <td colspan="2"><strong>{{ordenSeleccionada?.total | currency:'Q '}}</strong></td>
                </tr>
            </tbody>
        </table>

        <div class="modal-actions">
            <button type="button" class="btn-cancel" (click)="cerrarModalDetalles()">
                Cerrar
            </button>
        </div>
    </div>
</div>