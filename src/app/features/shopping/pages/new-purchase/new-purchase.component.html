<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="container">
    <button class="btn-back" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Volver
    </button>
    
    <div class="header">
        <h2>Órdenes de Compra</h2>
        <div class="header-actions">
            <app-input-search 
                [placeholder]="'Buscar órdenes...'" 
                (searchChange)="handleSearch($event)">
            </app-input-search>
            <button (click)="openAddOrderModal()" class="btn add-btn" [disabled]="isLoading">
                <span class="material-icons">add</span>
            </button>
        </div>
    </div>

    <div *ngIf="isLoading && orders.length === 0" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div *ngIf="!isLoading && filteredOrders.length === 0" class="no-results">
        No se encontraron órdenes de compra
    </div>

    <table *ngIf="filteredOrders.length > 0">
        <thead>
            <tr>
                <th>ID</th>
                <th>Proveedor</th>
                <th>Fecha</th>
                <th>Productos</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let order of paginatedOrders">
                <td class="text-center">{{ order.idOrder }}</td>
                <td class="text-center">{{ getSupplierName(order.idSupplier) }}</td>
                <td class="text-center">{{ order.created_at | date:'shortDate' }}</td>
                <td class="text-center">{{ getProductsCount(order) }}</td>
                <td class="text-center">Q{{ getOrderTotal(order) | number:'1.2-2' }}</td>
                <td class="text-center">
                    <span [class]="getStatusClass(order.status)">
                        {{ getStatusText(order.status) }}
                    </span>
                </td>
                <td class="btn-actions text-center">
                    <button class="btn btn-info" (click)="openEditOrderModal(order)" 
                        [disabled]="isLoading || order.status === 'V' || order.status === 'C' || order.status === 'R'">
                        Editar
                    </button>
                    <button class="btn btn-secondary" (click)="downloadPdf(order.idOrder)" [disabled]="isLoading">
                        PDF
                    </button>
                    <button class="btn btn-status" (click)="openStatusModal(order)" 
                        [disabled]="isLoading || order.status === 'C' || order.status === 'R'">
                        Estados
                    </button>
                    <button class="btn btn-receive" (click)="openReceiveModal(order)" 
                        [disabled]="isLoading || order.status !== 'V'">
                        Recibir
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="pagination-controls" *ngIf="filteredOrders.length > itemsPerPage">
        <button (click)="previousPage()" [disabled]="currentPage === 1" class="btn-pagination">
            Anterior
        </button>
        <span>Página {{currentPage}} de {{totalPages}}</span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn-pagination">
            Siguiente
        </button>
    </div>
</div>

<div *ngIf="showOrderModal" class="modal-overlay">
    <div class="modal-content purchase-modal">
        <h2>{{ isEditing ? 'Editar Orden de Compra' : 'Nueva Orden de Compra' }}</h2>
        
        <div class="purchase-container">
            <div class="form-section">
                <div class="dropdown-group">
                    <label for="provider">Proveedor:</label>
                    <select id="provider" [(ngModel)]="selectedSupplierId" (change)="onSupplierChange()" [disabled]="isEditing">
                        <option [ngValue]="null" disabled selected>Seleccione el Proveedor</option>
                        <option *ngFor="let supplier of suppliers" [ngValue]="supplier.idSupplier">
                            {{ supplier.nameSupplier }}
                        </option>
                    </select>
                </div>

                <div class="dropdown-group">
                    <label for="product">Productos:</label>
                    <select id="product" [(ngModel)]="selectedProductId" [disabled]="!selectedSupplierId">
                        <option [ngValue]="null" disabled selected>Seleccione Producto</option>
                        <option *ngFor="let product of filteredProducts" [ngValue]="product.idProduct">
                            {{ product.nameProduct }}
                        </option>
                    </select>
                </div>

                <div class="cantidad-agregar-group">
                    <div class="quantity-group">
                        <label for="quantity">Cantidad:</label>
                        <input type="number" id="quantity" [(ngModel)]="quantity" min="1" value="1" />
                    </div>
                    <button class="btn agregar-btn" (click)="addProduct()">Agregar</button>
                </div>
            </div>

            <div class="stock-added-container">
                <div class="stock-bajo" *ngIf="productosBajoStock.length > 0">
                    <h3>Productos con bajo stock</h3>
                    <ul>
                        <li *ngFor="let producto of productosBajoStock">
                            {{ producto.nameProduct }} <span>(Stock mínimo: {{ producto.minStock }})</span>
                        </li>
                    </ul>
                </div>

                <div class="productos-agregados">
                    <h3>Productos agregados</h3>
                    <table *ngIf="productosAgregados.length > 0">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Compra</th>
                                <th>Precio Venta</th>
                                <th>Total</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of paginatedProductosAgregados; let i = index">
                                <td>{{ item.nameProduct }}</td>
                                <td>
                                    <input type="number" [(ngModel)]="item.quantity" min="1" 
                                        (change)="updateQuantity(i, item.quantity)">
                                </td>
                                <td>
                                    <input type="number" [(ngModel)]="item.priceBuy" min="0" step="0.01"
                                        (change)="updatePrice(i, item.priceBuy)">
                                </td>
                                <td>
                                    <input type="number" [(ngModel)]="item.salePrice" min="0" step="0.01"
                                        (change)="updateSalePrice(i, item.salePrice || 0)">
                                </td>
                                <td>Q{{ (item.quantity * item.priceBuy) | number:'1.2-2' }}</td>
                                <td>
                                    <button class="btn quitar-btn" (click)="removeProduct(i)">Quitar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination-controls" *ngIf="productosAgregados.length > receiveItemsPerPage">
                        <button (click)="previousReceivePage()" [disabled]="currentReceivePage === 1" class="btn-pagination">
                            Anterior
                        </button>
                        <span>Página {{currentReceivePage}} de {{totalReceivePages}}</span>
                        <button (click)="nextReceivePage()" [disabled]="currentReceivePage === totalReceivePages" class="btn-pagination">
                            Siguiente
                        </button>
                    </div>
                    <p *ngIf="productosAgregados.length === 0">No hay productos agregados</p>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-submit" (click)="isEditing ? updateOrder() : generateOrder()" 
                [disabled]="productosAgregados.length === 0 || !selectedSupplierId || isLoading">
                {{ isLoading ? (isEditing ? 'Actualizando...' : 'Guardando...') : (isEditing ? 'Actualizar' : 'Guardar') }}
            </button>
            <button type="button" class="btn-cancel" (click)="closeOrderModal()" [disabled]="isLoading">
                Cancelar
            </button>
            <button type="button" class="btn-pdf" (click)="generateAndDownloadPdf()" 
                *ngIf="isEditing && currentOrder" [disabled]="isLoading">
                Generar PDF
            </button>
        </div>
    </div>
</div>

<div *ngIf="showStatusModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Cambiar Estado de la Orden</h2>
        
        <div class="form-group">
            <label for="status">Nuevo Estado:</label>
            <select id="status" [(ngModel)]="newStatus" class="form-control">
                <option value="S" *ngIf="currentOrder?.status === 'P'">Enviado</option>
                <option value="V" *ngIf="currentOrder?.status === 'S'">Confirmado</option>
                <!-- <option value="R" *ngIf="currentOrder?.status === 'V'">Recibido</option> -->
                <option value="C">Cancelado</option>
            </select>
        </div>

        <div class="form-group" *ngIf="newStatus === 'C'">
            <label for="statusDescription">Motivo de Cancelación (máx. 75 caracteres):</label>
            <textarea id="statusDescription" [(ngModel)]="statusDescription" class="form-control" maxlength="75"></textarea>
            <small *ngIf="statusDescription">{{ statusDescription.length }}/75 caracteres</small>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-submit" (click)="updateOrderStatus()" [disabled]="isLoading">
                {{ isLoading ? 'Actualizando...' : 'Actualizar' }}
            </button>
            <button type="button" class="btn-cancel" (click)="closeStatusModal()" [disabled]="isLoading">
                Cancelar
            </button>
        </div>
    </div>
</div>

<div *ngIf="showReceiveModal" class="modal-overlay">
    <div class="modal-content receive-modal">
        <h2>Recibir Orden #{{ currentOrder?.idOrder }}</h2>
        
        <div class="form-group">
            <label for="receiveDescription">Descripción (opcional):</label>
            <textarea id="receiveDescription" [(ngModel)]="receiveDescription" class="form-control"></textarea>
        </div>

        <div class="productos-recibir">
            <h3>Productos a recibir</h3>
            <table *ngIf="productosAgregados.length > 0">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Compra</th>
                        <th>Precio Venta</th>
                        <th>Total</th>
                        <th>Observación</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of paginatedProductosAgregados; let i = index">
                        <td>{{ item.nameProduct }}</td>
                        <td>
                            <input type="number" [(ngModel)]="item.quantity" min="1" 
                                (change)="updateQuantity(i, item.quantity)">
                        </td>
                        <td>
                            <input type="number" [(ngModel)]="item.priceBuy" min="0" step="0.01"
                                (change)="updatePrice(i, item.priceBuy)">
                        </td>
                        <td>
                            <input type="number" [(ngModel)]="item.salePrice" min="0" step="0.01"
                                (change)="updateSalePrice(i, item.salePrice || 0)">
                        </td>
                        <td>Q{{ (item.quantity * item.priceBuy) | number:'1.2-2' }}</td>
                        <td>
                            <input type="text" [(ngModel)]="item.observation" 
                                (change)="updateObservation(i, item.observation || '')" placeholder="Observación">
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination-controls" *ngIf="productosAgregados.length > receiveItemsPerPage">
                <button (click)="previousReceivePage()" [disabled]="currentReceivePage === 1" class="btn-pagination">
                    Anterior
                </button>
                <span>Página {{currentReceivePage}} de {{totalReceivePages}}</span>
                <button (click)="nextReceivePage()" [disabled]="currentReceivePage === totalReceivePages" class="btn-pagination">
                    Siguiente
                </button>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-submit" (click)="receiveOrder()" [disabled]="isLoading || productosAgregados.length === 0">
                {{ isLoading ? 'Procesando...' : 'Recibir Orden' }}
            </button>
            <button type="button" class="btn-cancel" (click)="closeReceiveModal()" [disabled]="isLoading">
                Cancelar
            </button>
        </div>
    </div>
</div>