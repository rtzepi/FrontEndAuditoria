<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="container">
    <button class="btn-back" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Volver
    </button>
    <div class="header">
        <h2>Productos</h2>
        <div class="header-actions">
            <app-input-search
                placeholder="Buscar productos..."
                (searchChange)="handleSearch($event)">
            </app-input-search>
            <button (click)="openAddProductModal()" class="btn btn-primary add-product-btn" 
                [disabled]="isLoading || isReadOnly">
                <span class="material-icons">add</span>
            </button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Categoría</th>
                <th>Proveedor</th>
                <th>Unidad de Medida</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let product of paginatedProducts">
                <td>{{ product.idProduct }}</td>
                <td>
                    <div class="product-image-container">
                        <img *ngIf="product.picture" 
                            [src]="product.picture"
                            class="product-img" alt="Imagen producto">
                        <div *ngIf="!product.picture" class="initials">
                            {{ product.nameProduct | slice:0:2 | uppercase }}
                        </div>
                    </div>
                </td>
                <td>{{ product.nameProduct }}</td>
                <td>{{ product.description || 'N/A' }}</td>
                <td>{{ getCategoryName(product.idCategory) }}</td>
                <td>{{ getSupplierName(product.idSupplier) }}</td>
                <td>{{ getUnitOfSaleName(product.idUnitOfSale) }}</td>
                <td>
                    <span [class.active]="product.status === 'E'" [class.inactive]="product.status !== 'E'">
                        {{ product.status === 'E' ? 'Activo' : 'Inactivo' }}
                    </span>
                </td>
                <td class="btn-actions">
                    <button class="btn btn-info" (click)="openEditProductModal(product)" 
                        [disabled]="isLoading || isReadOnly">Editar</button>
                    <button class="btn btn-danger" (click)="confirmDelete(product)" 
                        [disabled]="isLoading || isReadOnly">Eliminar</button>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="pagination-controls" *ngIf="products.length > itemsPerPage">
        <button (click)="previousPage()" [disabled]="currentPage === 1" class="btn-pagination">
            Anterior
        </button>
        <span>Página {{currentPage}} de {{totalPages}}</span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn-pagination">
            Siguiente
        </button>
    </div>
</div>

<div *ngIf="showModal" class="modal-overlay">
    <div class="modal-content">
        <h2>{{ isEditing ? 'Editar Producto' : 'Agregar Producto' }}</h2>
        
        <form #productForm="ngForm" (ngSubmit)="onSubmit()" class="product-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre del Producto <span class="required">*</span></label>
                    <input type="text" [(ngModel)]="newProduct.nameProduct" name="nameProduct" 
                        required maxlength="50" #nameProduct="ngModel"
                        (input)="validateNameProduct()"
                        [readonly]="isReadOnly">
                    <div *ngIf="nameProduct.invalid && (nameProduct.dirty || nameProduct.touched)" class="error-message">
                        <span *ngIf="nameProduct.errors?.['required']">Nombre del producto es requerido</span>
                        <span *ngIf="nameProduct.errors?.['maxlength']">Máximo 50 caracteres</span>
                    </div>
                    <div class="character-counter">
                        {{ (newProduct.nameProduct ? newProduct.nameProduct.length : 0) }}/50
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Estado <span class="required">*</span></label>
                    <select [(ngModel)]="newProduct.status" name="status" required #status="ngModel" 
                        [disabled]="isReadOnly">
                        <option value="">Seleccione un estado</option>
                        <option value="E">Activo</option>
                        <option value="D">Inactivo</option>
                    </select>
                    <div *ngIf="status.invalid && (status.dirty || status.touched)" class="error-message">
                        Estado es requerido
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categoría <span class="required">*</span></label>
                    <select [(ngModel)]="newProduct.idCategory" name="idCategory" required #idCategory="ngModel"
                        [disabled]="isReadOnly">
                        <option [ngValue]="null">Seleccione una categoría</option>
                        <option *ngFor="let category of categories" [ngValue]="category.idCategory">
                            {{ category.categoryName }}
                        </option>
                    </select>
                    <div *ngIf="idCategory.invalid && (idCategory.dirty || idCategory.touched)" class="error-message">
                        Categoría es requerida
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Proveedor <span class="required">*</span></label>
                    <select [(ngModel)]="newProduct.idSupplier" name="idSupplier" required #idSupplier="ngModel"
                        [disabled]="isReadOnly">
                        <option [ngValue]="null">Seleccione un proveedor</option>
                        <option *ngFor="let supplier of suppliers" [ngValue]="supplier.idSupplier">
                            {{ supplier.nameSupplier }}
                        </option>
                    </select>
                    <div *ngIf="idSupplier.invalid && (idSupplier.dirty || idSupplier.touched)" class="error-message">
                        Proveedor es requerido
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Unidad de Medida</label>
                    <select [(ngModel)]="newProduct.idUnitOfSale" name="idUnitOfSale"
                        [disabled]="isReadOnly">
                        <option [ngValue]="null">Seleccione una unidad</option>
                        <option *ngFor="let unit of unitsOfSale" [ngValue]="unit.idUnitOfSale">
                            {{ unit.unityName }} ({{ unit.abbreviation }})
                        </option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Descripción <span class="required">*</span></label>
                <textarea [(ngModel)]="newProduct.description" name="description" 
                        required maxlength="100" #description="ngModel"
                        (input)="validateDescription()"
                        [readonly]="isReadOnly"></textarea>
                <div *ngIf="description.invalid && (description.dirty || description.touched)" class="error-message">
                    <span *ngIf="description.errors?.['required']">Descripción es requerida</span>
                    <span *ngIf="description.errors?.['maxlength']">Máximo 100 caracteres</span>
                </div>
                <div class="character-counter">
                    {{ (newProduct.description ? newProduct.description.length : 0) }}/100
                </div>
            </div>

            <div class="form-group photo-upload">
                <label>Imagen del Producto <span class="required">*</span></label>
                <div class="upload-container">
                    <div class="image-preview" *ngIf="imagePreview">
                        <img [src]="imagePreview" alt="Vista previa">
                        <button *ngIf="!isReadOnly" type="button" class="btn-remove" (click)="removePhoto()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="upload-controls">
                        <input type="file" id="productPhoto" (change)="handleImageUpload($event)" 
                            accept="image/*" [disabled]="isLoading || isReadOnly" hidden>
                        <label for="productPhoto" class="btn-upload" *ngIf="!isReadOnly">
                            <span class="material-icons">upload</span>
                            {{ imagePreview ? 'Cambiar imagen' : 'Subir imagen' }}
                        </label>
                        <small *ngIf="!isReadOnly">Tamaño máximo: 2MB (JPEG, PNG, JPG)</small>
                        <div *ngIf="(formSubmitted || photoTouched) && !newProduct.imgBase64 && !isEditing" class="error-message">
                            La imagen del producto es obligatoria
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button *ngIf="!isReadOnly" type="submit" 
                        class="btn-submit"
                        [disabled]="productForm.invalid || isLoading || (!newProduct.imgBase64 && !isEditing)">
                    {{ isLoading ? (isEditing ? 'Actualizando...' : 'Guardando...') : (isEditing ? 'Actualizar' : 'Guardar') }}
                </button>
                <button type="button" 
                        class="btn-cancel"
                        (click)="closeModal()"
                        [disabled]="isLoading">
                    {{ isReadOnly ? 'Cerrar' : 'Cancelar' }}
                </button>
            </div>
        </form>
    </div>
</div>