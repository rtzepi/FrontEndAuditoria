<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="container">
    <button class="btn-back" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Volver
    </button>
    <div class="header">
        <h2>Gestión de Proveedores</h2>
        <div class="header-actions">
            <app-input-search
                placeholder="Buscar proveedores..."
                (searchChange)="handleSearch($event)">
            </app-input-search>
            <button (click)="openAddSupplierModal()" class="btn btn-primary add-supplier-btn" [disabled]="isLoading">
                <span class="material-icons">add</span></button>
        </div>
    </div>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Proveedor</th>
                    <th>Contacto</th>
                    <th>Teléfono</th>
                    <th>Teléfono Contacto</th>
                    <th>Email</th>
                    <th>Dirección</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let supplier of paginatedSuppliers">
                    <td>{{ supplier.idSupplier }}</td>
                    <td>{{ supplier.nameSupplier }}</td>
                    <td>{{ supplier.nameContact }}</td>
                    <td>{{ supplier.phoneNumber }}</td>
                    <td>{{ supplier.phoneNumberContact || '-' }}</td>
                    <td>{{ supplier.email }}</td>
                    <td>{{ supplier.address }}</td>
                    <td>
                        <span class="badge" [ngClass]="{
                            'badge-success': supplier.status === 'A' || supplier.status === 'st',
                            'badge-warning': supplier.status === 'I'
                        }">
                            {{ getStatusText(supplier.status) }}
                        </span>
                    </td>
                    <td class="btn-actions">
                        <button class="btn btn-info" (click)="openEditSupplierModal(supplier)" [disabled]="isLoading">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-danger" (click)="confirmDelete(supplier)" [disabled]="isLoading">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                </tr>
                <tr *ngIf="filteredSuppliers.length === 0">
                    <td colspan="9" class="text-center">No se encontraron proveedores</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-controls" *ngIf="filteredSuppliers.length > itemsPerPage">
        <button (click)="previousPage()" [disabled]="currentPage === 1" class="btn-pagination">
            <span class="material-icons">chevron_left</span>
            Anterior
        </button>
        <span>Página {{currentPage}} de {{totalPages}}</span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn-pagination">
            Siguiente
            <span class="material-icons">chevron_right</span>
        </button>
    </div>
</div>

<div *ngIf="showModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{{ isEditing ? 'Editar Proveedor' : 'Agregar Nuevo Proveedor' }}</h2>
        </div>
        
        <form #supplierForm="ngForm" (ngSubmit)="onSubmit()" class="supplier-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="nameSupplier">Nombre Proveedor <span class="required">*</span></label>
                    <input type="text" id="nameSupplier" [(ngModel)]="newSupplier.nameSupplier" name="nameSupplier" 
                        required maxlength="{{MAX_NAME_LENGTH}}" #nameSupplier="ngModel"
                        (input)="handleInput('nameSupplier', MAX_NAME_LENGTH, $event)">
                    <div class="char-counter"
                        [class.warning]="getRemainingChars('nameSupplier', MAX_NAME_LENGTH) < 10"
                        [class.danger]="getRemainingChars('nameSupplier', MAX_NAME_LENGTH) === 0">
                        Caracteres restantes: {{ getRemainingChars('nameSupplier', MAX_NAME_LENGTH) }}
                    </div>
                    <div *ngIf="nameSupplier.invalid && (nameSupplier.dirty || nameSupplier.touched || formSubmitted)" 
                        class="error-message">
                        El nombre del proveedor es requerido (máx. {{MAX_NAME_LENGTH}} caracteres)
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="nameContact">Nombre Contacto <span class="required">*</span></label>
                    <input type="text" id="nameContact" [(ngModel)]="newSupplier.nameContact" name="nameContact" 
                        required maxlength="{{MAX_NAME_LENGTH}}" #nameContact="ngModel"
                        (input)="handleInput('nameContact', MAX_NAME_LENGTH, $event)">
                    <div class="char-counter"
                        [class.warning]="getRemainingChars('nameContact', MAX_NAME_LENGTH) < 10"
                        [class.danger]="getRemainingChars('nameContact', MAX_NAME_LENGTH) === 0">
                        Caracteres restantes: {{ getRemainingChars('nameContact', MAX_NAME_LENGTH) }}
                    </div>
                    <div *ngIf="nameContact.invalid && (nameContact.dirty || nameContact.touched || formSubmitted)" 
                        class="error-message">
                        El nombre de contacto es requerido (máx. {{MAX_NAME_LENGTH}} caracteres)
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="phoneNumber">Teléfono Proveedor <span class="required">*</span></label>
                    <input type="text" id="phoneNumber" [(ngModel)]="newSupplier.phoneNumber" name="phoneNumber"
                        required pattern="[0-9]{8}" maxlength="{{MAX_PHONE_LENGTH}}" #phoneNumber="ngModel"
                        (keypress)="validateNumber($event)"
                        (input)="handleInput('phoneNumber', MAX_PHONE_LENGTH, $event)">
                    <div class="char-counter"
                        [class.warning]="getRemainingChars('phoneNumber', MAX_PHONE_LENGTH) < 2"
                        [class.danger]="getRemainingChars('phoneNumber', MAX_PHONE_LENGTH) === 0">
                        Caracteres restantes: {{ getRemainingChars('phoneNumber', MAX_PHONE_LENGTH) }}
                    </div>
                    <div *ngIf="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched || formSubmitted)" 
                        class="error-message">
                        <span *ngIf="phoneNumber.errors?.['required']">Teléfono es requerido</span>
                        <span *ngIf="phoneNumber.errors?.['pattern']">Debe contener exactamente 8 dígitos</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="phoneNumberContact">Teléfono Contacto</label>
                    <input type="text" id="phoneNumberContact" [(ngModel)]="newSupplier.phoneNumberContact"
                        name="phoneNumberContact" pattern="[0-9]{8}" maxlength="{{MAX_PHONE_LENGTH}}" 
                        #phoneNumberContact="ngModel" (keypress)="validateNumber($event)"
                        (input)="handleInput('phoneNumberContact', MAX_PHONE_LENGTH, $event)">
                    <div class="char-counter"
                        [class.warning]="getRemainingChars('phoneNumberContact', MAX_PHONE_LENGTH) < 2"
                        [class.danger]="getRemainingChars('phoneNumberContact', MAX_PHONE_LENGTH) === 0">
                        Caracteres restantes: {{ getRemainingChars('phoneNumberContact', MAX_PHONE_LENGTH) }}
                    </div>
                    <div *ngIf="phoneNumberContact.invalid && (phoneNumberContact.dirty || phoneNumberContact.touched)" 
                        class="error-message">
                        <span *ngIf="phoneNumberContact.errors?.['pattern']">Debe contener exactamente 8 dígitos</span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email <span class="required">*</span></label>
                    <input type="email" id="email" [(ngModel)]="newSupplier.email" name="email" 
                        required email maxlength="{{MAX_EMAIL_LENGTH}}" #email="ngModel"
                        (input)="handleInput('email', MAX_EMAIL_LENGTH, $event)">
                    <div class="char-counter"
                        [class.warning]="getRemainingChars('email', MAX_EMAIL_LENGTH) < 10"
                        [class.danger]="getRemainingChars('email', MAX_EMAIL_LENGTH) === 0">
                        Caracteres restantes: {{ getRemainingChars('email', MAX_EMAIL_LENGTH) }}
                    </div>
                    <div *ngIf="email.invalid && (email.dirty || email.touched || formSubmitted)" 
                        class="error-message">
                        <span *ngIf="email.errors?.['required']">Email es requerido</span>
                        <span *ngIf="email.errors?.['email']">Formato de email inválido</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="address">Dirección <span class="required">*</span></label>
                    <input type="text" id="address" [(ngModel)]="newSupplier.address" name="address" 
                        required maxlength="{{MAX_ADDRESS_LENGTH}}" #address="ngModel"
                        (input)="handleInput('address', MAX_ADDRESS_LENGTH, $event)">
                    <div class="char-counter"
                        [class.warning]="getRemainingChars('address', MAX_ADDRESS_LENGTH) < 10"
                        [class.danger]="getRemainingChars('address', MAX_ADDRESS_LENGTH) === 0">
                        Caracteres restantes: {{ getRemainingChars('address', MAX_ADDRESS_LENGTH) }}
                    </div>
                    <div *ngIf="address.invalid && (address.dirty || address.touched || formSubmitted)" 
                        class="error-message">
                        La dirección es requerida (máx. {{MAX_ADDRESS_LENGTH}} caracteres)
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="status">Estado <span class="required">*</span></label>
                    <select id="status" [(ngModel)]="newSupplier.status" name="status" required #status="ngModel">
                        <option value="st">Activo</option>
                        <option value="I">Inactivo</option>
                    </select>
                    <div *ngIf="status.invalid && (status.dirty || status.touched || formSubmitted)" 
                        class="error-message">
                        El estado es requerido
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="observation">Observaciones</label>
                    <textarea id="observation" [(ngModel)]="newSupplier.observation" name="observation" 
                            rows="2" maxlength="{{MAX_OBSERVATION_LENGTH}}"
                            (input)="handleInput('observation', MAX_OBSERVATION_LENGTH, $event)"></textarea>
                    <div class="char-counter"
                        [class.warning]="getRemainingChars('observation', MAX_OBSERVATION_LENGTH) < 30"
                        [class.danger]="getRemainingChars('observation', MAX_OBSERVATION_LENGTH) === 0">
                        Caracteres restantes: {{ getRemainingChars('observation', MAX_OBSERVATION_LENGTH) }}
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn-submit" [disabled]="supplierForm.invalid || isLoading">
                    {{ isLoading ? (isEditing ? 'Actualizando...' : 'Guardando...') : (isEditing ? 'Actualizar' : 'Guardar') }}
                </button>
                <button type="button" class="btn-cancel" (click)="closeModal()" [disabled]="isLoading">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>