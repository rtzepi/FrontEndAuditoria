<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="cash-closing-container">
    <button class="back-button" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Volver
    </button>
    
    <div class="header-section">
        <h1>Cierre de Caja</h1>
        <p class="subtitle">Procedimiento para finalizar la sesión</p>
    </div>

    <div *ngIf="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Cargando transacciones...</p>
    </div>

    <div *ngIf="!isLoading" class="content-section">
        <div class="summary-card">
            <div class="card-header">
                <span class="material-icons">summarize</span>
                <h2>Resumen Financiero</h2>
            </div>
            <div class="card-body">
                <div class="summary-row">
                    <span>Total Ingresos:</span>
                    <strong class="income">Q{{ getTotalIncome() | number:'1.2-2' }}</strong>
                </div>
                <div class="summary-row">
                    <span>Total Egresos:</span>
                    <strong class="expense">Q{{ getTotalExpenses() | number:'1.2-2' }}</strong>
                </div>
                <div class="summary-row total">
                    <span>Monto Esperado:</span>
                    <strong>Q{{ calculateExpectedAmount() | number:'1.2-2' }}</strong>
                </div>
            </div>
        </div>

        <div class="transactions-section" *ngIf="transactions.length > 0">
            <div class="section-header">
                <span class="material-icons">list_alt</span>
                <h2>Transacciones Registradas</h2>
                <span class="badge">{{ transactions.length }}</span>
            </div>
            
            <div class="transactions-list">
                <div class="transaction-item" *ngFor="let trx of transactions">
                    <div class="transaction-icon" [ngClass]="trx.trnType === 'Ingreso' ? 'income' : 'expense'">
                        <span class="material-icons">
                            {{ trx.trnType === 'Ingreso' ? 'arrow_circle_up' : 'arrow_circle_down' }}
                        </span>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-header">
                            <span class="transaction-type">{{ getTransactionType(trx.trnType) }}</span>
                            <span class="transaction-amount" [ngClass]="trx.trnType === 'Ingreso' ? 'income' : 'expense'">
                                {{ trx.trnType === 'Ingreso' ? '+' : '-' }}Q{{ trx.amount | number:'1.2-2' }}
                            </span>
                        </div>
                        <p class="transaction-description">{{ trx.description || 'Sin descripción' }}</p>
                        <div class="transaction-footer">
                            <span class="transaction-date">{{ formatDate(trx.transactionDate) }}</span>
                            <span class="transaction-id">#{{ trx.idDailyTransaction }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div *ngIf="showCloseForm" class="close-form">
            <div class="form-header">
                <span class="material-icons">lock_clock</span>
                <h2>Datos de Cierre</h2>
            </div>
            
            <div class="form-group">
                <label for="closingAmount">
                    <span class="material-icons">payments</span>
                    Monto Final *
                </label>
                <input type="number" 
                        id="closingAmount" 
                        [(ngModel)]="closeData.closingAmount" 
                        name="closingAmount"
                        placeholder="Monto real en caja"
                        required
                        min="0"
                        step="0.01">
            </div>
            
            <div class="form-group">
                <label for="replenishedAmount">
                    <span class="material-icons">savings</span>
                    Monto Repuesto *
                </label>
                <input type="number" 
                        id="replenishedAmount" 
                        [(ngModel)]="closeData.replenishedAmount" 
                        name="replenishedAmount"
                        placeholder="Monto repuesto"
                        required
                        min="0"
                        step="0.01">
            </div>
            
            <div class="form-group">
                <label for="observation">
                    <span class="material-icons">notes</span>
                    Observaciones
                </label>
                <textarea id="observation" 
                            [(ngModel)]="closeData.observation" 
                            name="observation"
                            rows="3"
                            placeholder="Notas adicionales..."></textarea>
            </div>

            <div class="difference-row">
                <span>Diferencia:</span>
                <strong [ngClass]="{
                    'positive': getDifference() >= 0,
                    'negative': getDifference() < 0
                }">
                    Q{{ getDifference() | number:'1.2-2' }}
                </strong>
            </div>

            <div class="form-actions">
                <button type="button" class="cancel-button" (click)="showCloseForm = false">
                    Cancelar
                </button>
                <button type="button" 
                        class="submit-button"
                        (click)="confirmCloseSession()"
                        [disabled]="!validateCloseForm() || closingInProgress">
                    <span class="material-icons">lock</span>
                    {{ closingInProgress ? 'Procesando...' : 'Confirmar Cierre' }}
                </button>
            </div>
        </div>

        <button *ngIf="!showCloseForm" 
                class="initiate-close-button"
                (click)="prepareCloseSession()">
            <span class="material-icons">lock</span>
            Iniciar Cierre de Caja
        </button>
    </div>
</div>