<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="container">
    <button class="btn-back" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Volver
    </button>
    
    <div class="header">
        <h2>Roles</h2>
        <div class="header-actions">
            <app-input-search
                placeholder="Buscar roles..."
                (searchChange)="handleSearch($event)">
            </app-input-search>
            <button (click)="openAddRoleModal()" class="btn btn-primary add-role-btn" [disabled]="isLoading">
                <span class="material-icons">add</span>
            </button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre del Rol</th>
                <th>Descripción</th>
                <th>Estado</th>
                <th>Notificaciones</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let role of paginatedRoles">
                <td>{{ role.idRole }}</td>
                <td>{{ role.roleName }}</td>
                <td>{{ role.description || 'Sin descripción' }}</td>
                <td>
                    <span [class.active]="role.status === 'E'" [class.inactive]="role.status !== 'E'">
                        {{ role.status === 'E' ? 'Activo' : 'Inactivo' }}
                    </span>
                </td>
                <td>
                    <span class="material-icons" [class.active]="role.isNotify">
                        {{ role.isNotify ? 'notifications_active' : 'notifications_off' }}
                    </span>
                </td>
                <td class="btn-actions">
                    <button class="btn btn-info" (click)="openEditRoleModal(role)" [disabled]="isLoading">
                        Editar
                    </button>
                    <button class="btn btn-danger" (click)="confirmDelete(role)" [disabled]="isLoading">
                        Eliminar
                    </button>
                </td>
            </tr>
            <tr *ngIf="filteredRoles.length === 0">
                <td colspan="6" class="no-results">
                    {{ isLoading ? 'Cargando...' : 'No se encontraron roles' }}
                </td>
            </tr>
        </tbody>
    </table>

    <div class="pagination-controls" *ngIf="filteredRoles.length > itemsPerPage">
        <button (click)="previousPage()" [disabled]="currentPage === 1" class="btn-pagination">
            Anterior
        </button>
        <span>Página {{currentPage}} de {{totalPages}}</span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn-pagination">
            Siguiente
        </button>
    </div>
</div>

<div *ngIf="showModal" class="modal-overlay">
    <div class="modal-content">
        <h2>{{ isEditing ? 'Editar Rol' : 'Agregar Rol' }}</h2>
        
        <form #roleForm="ngForm" (ngSubmit)="isEditing ? updateRole() : addRole()" class="role-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre del Rol <span class="required">*</span></label>
                    <input type="text" 
                        [(ngModel)]="newRole.roleName" 
                        name="roleName" 
                        required 
                        #roleName="ngModel"
                        maxlength="50"
                        (input)="checkRoleNameExists()">
                    <div *ngIf="roleName.invalid && (roleName.dirty || roleName.touched)" class="error-message">
                        <div *ngIf="roleName.errors?.['required']">Nombre del rol es requerido</div>
                        <div *ngIf="roleName.errors?.['maxlength']">El nombre no puede exceder los 50 caracteres</div>
                        <div *ngIf="roleName.errors?.['nameExists']">Este nombre de rol ya existe</div>
                    </div>
                    <div class="character-counter">{{ newRole.roleName? newRole.roleName.length: 0 }}/50</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea [(ngModel)]="newRole.description" 
                            name="description" 
                            rows="3"
                            maxlength="200"
                            #description="ngModel"></textarea>
                    <div *ngIf="description.errors?.['maxlength']" class="error-message">
                        La descripción no puede exceder los 200 caracteres
                    </div>
                    <div class="character-counter">{{ newRole.description?.length || 0 }}/200</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Estado <span class="required">*</span></label>
                    <select [(ngModel)]="newRole.status" name="status" required #status="ngModel">
                        <option value="E">Activo</option>
                        <option value="D">Inactivo</option>
                    </select>
                    <div *ngIf="status.invalid && (status.dirty || status.touched)" class="error-message">
                        Estado es requerido
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" [(ngModel)]="newRole.isNotify" name="isNotify">
                        Habilitar notificaciones
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" 
                        class="btn-submit"
                        [disabled]="roleForm.invalid || isLoading || nameExists">
                    {{ isLoading ? (isEditing ? 'Actualizando...' : 'Guardando...') : (isEditing ? 'Actualizar' : 'Guardar') }}
                </button>
                <button type="button" 
                        class="btn-cancel"
                        (click)="closeModal()"
                        [disabled]="isLoading">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>