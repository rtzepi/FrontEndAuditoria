<p>sales-history works!</p>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="container" [class.modal-open]="showDetailsModal">
    <button class="btn-back" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Volver
    </button>
    
    <div class="header">
        <h2>Historial de Ventas</h2>
        <div class="header-actions">
            <app-input-search 
                [placeholder]="'Buscar ventas...'" 
                (searchChange)="handleSearch($event)">
            </app-input-search>
        </div>
    </div>

    <div *ngIf="isLoading && sales.length === 0" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div *ngIf="!isLoading && filteredSales.length === 0" class="no-results">
        No se encontraron ventas registradas
    </div>

    <div class="table-container">
        <table *ngIf="filteredSales.length > 0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Método de Pago</th>
                    <th>Subtotal</th>
                    <th>Descuento</th>
                    <th>Total</th>
                    <th>Usuario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let sale of paginatedSales">
                    <td data-label="ID">{{ sale.idSale }}</td>
                    <td data-label="Fecha">{{ sale.saleDate | date:'short' }}</td>
                    <td data-label="Método de Pago">{{ sale.typePayment }}</td>
                    <td data-label="Subtotal">Q{{ sale.subTotal | number:'1.2-2' }}</td>
                    <td data-label="Descuento">Q{{ sale.discountTotal | number:'1.2-2' }}</td>
                    <td data-label="Total">Q{{ sale.total | number:'1.2-2' }}</td>
                    <td data-label="Usuario">{{ sale.user }}</td>
                    <td class="btn-actions" data-label="Acciones">
                        <button class="btn btn-info" (click)="openDetailsModal(sale.idSale)" [disabled]="isLoading">
                            Detalles
                        </button>
                        <button class="btn btn-secondary" (click)="downloadPdf(sale.idSale)" [disabled]="isLoading">
                            Recibo
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-controls" *ngIf="filteredSales.length > itemsPerPage">
        <button (click)="previousPage()" [disabled]="currentPage === 1" class="btn-pagination">
            Anterior
        </button>
        <span>Página {{currentPage}} de {{totalPages}}</span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn-pagination">
            Siguiente
        </button>
    </div>
</div>

<div *ngIf="showDetailsModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Detalles de Venta #{{ saleDetails?.idSale }}</h2>
        
        <div class="sale-info">
            <div class="info-row">
                <span class="info-label">Fecha:</span>
                <span class="info-value">{{ saleDetails?.saleDate | date:'medium' }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Método de Pago:</span>
                <span class="info-value">{{ saleDetails?.typePayment }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Usuario:</span>
                <span class="info-value">{{ saleDetails?.user }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Observación:</span>
                <span class="info-value">{{ saleDetails?.observation || 'Ninguna' }}</span>
            </div>
        </div>

        <div class="products-table">
            <h3>Productos vendidos</h3>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Descuento</th>
                        <th>Subtotal</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of saleDetails?.sales">
                        <td>Producto #{{ item.idProduct }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>Q{{ item.unitPrice | number:'1.2-2' }}</td>
                        <td>Q{{ item.discount | number:'1.2-2' }}</td>
                        <td>Q{{ item.subTotal | number:'1.2-2' }}</td>
                        <td>Q{{ item.total | number:'1.2-2' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="totals-section">
            <div class="total-row">
                <span class="total-label">Subtotal:</span>
                <span class="total-value">Q{{ saleDetails?.subTotal | number:'1.2-2' }}</span>
            </div>
            <div class="total-row">
                <span class="total-label">Descuento Total:</span>
                <span class="total-value">Q{{ saleDetails?.discountTotal | number:'1.2-2' }}</span>
            </div>
            <div class="total-row">
                <span class="total-label">Total:</span>
                <span class="total-value">Q{{ saleDetails?.total | number:'1.2-2' }}</span>
            </div>
            <div class="total-row">
                <span class="total-label">Recibido:</span>
                <span class="total-value">Q{{ saleDetails?.amountReceive | number:'1.2-2' }}</span>
            </div>
            <div class="total-row">
                <span class="total-label">Cambio:</span>
                <span class="total-value">Q{{ saleDetails?.amountGive | number:'1.2-2' }}</span>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-submit" (click)="downloadPdf(saleDetails?.idSale || 0)" [disabled]="isLoading">
                {{ isLoading ? 'Generando...' : 'Generar Recibo' }}
            </button>
            <button type="button" class="btn-cancel" (click)="closeDetailsModal()" [disabled]="isLoading">
                Cerrar
            </button>
        </div>
    </div>
</div>